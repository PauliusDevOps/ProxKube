- name: Add Prometheus Helm repository
  ansible.builtin.command:
    cmd: "helm repo add prometheus-community https://prometheus-community.github.io/helm-charts"
  register: add_repo_result
  retries: 3
  delay: 30
  until: add_repo_result.rc == 0
  changed_when: false
  become: true
  become_user: "{{ ansible_user }}"

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: "helm repo update"
  register: update_repo_result
  retries: 3
  delay: 30
  until: update_repo_result.rc == 0
  changed_when: false
  become: true
  become_user: "{{ ansible_user }}"

- name: Create monitoring namespace
  ansible.builtin.command:
    cmd: "kubectl create namespace monitoring"
  register: create_ns_result
  retries: 3
  delay: 10
  until: create_ns_result.rc == 0
  changed_when: create_ns_result.rc == 0
  become: true
  become_user: "{{ ansible_user }}"
  ignore_errors: true
  
- name: Install Prometheus using Helm
  ansible.builtin.command:
    cmd: "helm install prometheus --namespace monitoring prometheus-community/kube-prometheus-stack"
  register: helm_install_result
  retries: 3
  delay: 30
  until: helm_install_result.rc == 0
  changed_when: helm_install_result.rc == 0
  become: true
  become_user: "{{ ansible_user }}"
  when: create_ns_result.rc == 0 or create_ns_result.rc == 1
