- name: Ensure Python 3 is installed
  ansible.builtin.package:
    name: python3
    state: present

- name: Ensure pip3 is installed
  ansible.builtin.package:
    name: python3-pip
    state: present

- name: Install Kubernetes Python library
  ansible.builtin.pip:
    name: kubernetes
    state: present
  become: true

- name: Apply StorageClass configuration
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf  # Adjust this path as needed
    state: present
    src: "{{ role_path }}/sc.yaml"
  become: true
  when: inventory_hostname == groups['masters'][0]


- name: Patch local-storage StorageClass to be default
  ansible.builtin.shell: |
    kubectl patch storageclass local-storage -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
  become: true
  changed_when: false
  when: inventory_hostname == groups['masters'][0]

- name: Add Portainer Helm repository
  kubernetes.core.helm_repository:
    name: portainer
    repo_url: https://portainer.github.io/k8s/
    state: present
  when: inventory_hostname == groups['masters'][0]

- name: Update Helm repositories
  kubernetes.core.helm_repository:
    name: portainer
    state: updated
  when: inventory_hostname == groups['masters'][0]

- name: Install or upgrade Portainer using Helm
  kubernetes.core.helm:
    name: portainer
    chart_ref: portainer/portainer
    namespace: portainer
    create_namespace: yes
    state: present
    set:
      - name: service.type
        value: LoadBalancer
  when: inventory_hostname == groups['masters'][0]

- name: Apply Portainer LoadBalancer manifest
  kubernetes.core.k8s:
    state: present
    namespace: portainer
    src: https://downloads.portainer.io/ce2-19/portainer-lb.yaml
  when: inventory_hostname == groups['masters'][0]
